<script>
    // 공통 추가 함수
    function addItem(containerSelector, templateId) {
        let container = document.querySelector(containerSelector);
        let template = document.querySelector(templateId);
        let clone = template.content.cloneNode(true);
        container.appendChild(clone);
        updateAllDropdownSelectedText(); // 드롭다운도 다시 바인딩
    }

    // 삭제 버튼 처리
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('removeItemBtn')) {
            event.target.closest('.linkItem, .educationItem, .experienceItem, .projectItem, .trainingItem, .etcItem').remove();
        }
    });

    // 이력서 업데이트 전송
    async function updateResume() {
        let resumeId = document.getElementById('resumeId').value;

        let requestBody = {
            title: document.querySelector("#title").value,
            summary: document.querySelector("#summary").value,
            selfIntroduction: document.querySelector("#selfIntroduction").value,
            isPublic: document.querySelector("#resumeToggle")?.checked ?? true,
            positionType: document.querySelector("select[name='positionType']").value,
            resumeTechStacks: Array.from(document.querySelectorAll(".techCheckbox:checked")).map(cb => cb.value),

            links: Array.from(document.querySelectorAll('.linkItem')).map(item => ({
                id: item.querySelector('.linkId')?.value || null,
                title: item.querySelector('.linkTitle')?.value || '',
                url: item.querySelector('.linkUrl')?.value || ''
            })),

            educations: Array.from(document.querySelectorAll('.educationItem')).map(item => ({
                id: item.querySelector('.educationId')?.value || null,
                graduationDate: item.querySelector('.educationGraduationDate')?.value ? item.querySelector('.educationGraduationDate').value + "-01" : null,
                isDropout: item.querySelector('.educationIsDropout')?.checked || false,
                schoolName: item.querySelector('.educationSchoolName')?.value || '',
                major: item.querySelector('.educationMajor')?.value || '',
                educationLevel: item.querySelector('.educationLevel')?.value || '',
                gpa: item.querySelector('.educationGpa')?.value || '',
                gpaScale: item.querySelector('.educationGpaScale')?.value || ''
            })),

            experiences: Array.from(document.querySelectorAll('.experienceItem')).map(item => ({
                id: item.querySelector('.experienceId')?.value || null,
                startDate: item.querySelector('.experienceStartDate')?.value || '',
                endDate: item.querySelector('.experienceEndDate')?.value || '',
                isEmployed: item.querySelector('.experienceIsEmployed')?.checked || false,
                companyName: item.querySelector('.experienceCompanyName')?.value || '',
                summary: item.querySelector('.experienceSummary')?.value || '',
                position: item.querySelector('.experiencePosition')?.value || '',
                responsibility: item.querySelector('.experienceResponsibility')?.value || '',
                techStacks: Array.from(item.querySelectorAll('.experienceTechCheckbox:checked')).map(cb => cb.value)
            })),

            projects: Array.from(document.querySelectorAll('.projectItem')).map(item => ({
                id: item.querySelector('.projectId')?.value || null,
                startDate: item.querySelector('.projectStartDate')?.value || '',
                endDate: item.querySelector('.projectEndDate')?.value || '',
                isOngoing: item.querySelector('.projectIsOngoing')?.checked || false,
                title: item.querySelector('.projectTitle')?.value || '',
                summary: item.querySelector('.projectSummary')?.value || '',
                description: item.querySelector('.projectDescription')?.value || '',
                repositoryUrl: item.querySelector('.projectRepoUrl')?.value || '',
                techStacks: Array.from(item.querySelectorAll('.projectTechCheckbox:checked')).map(cb => cb.value)
            })),

            trainings: Array.from(document.querySelectorAll('.trainingItem')).map(item => ({
                id: item.querySelector('.trainingId')?.value || null,
                startDate: item.querySelector('.trainingStartDate')?.value || '',
                endDate: item.querySelector('.trainingEndDate')?.value || '',
                isOngoing: item.querySelector('.trainingIsOngoing')?.checked || false,
                courseName: item.querySelector('.trainingCourseName')?.value || '',
                institutionName: item.querySelector('.trainingInstitutionName')?.value || '',
                description: item.querySelector('.trainingDescription')?.value || '',
                techStacks: Array.from(item.querySelectorAll('.trainingTechCheckbox:checked')).map(cb => cb.value)
            })),

            etcs: Array.from(document.querySelectorAll('.etcItem')).map(item => ({
                id: item.querySelector('.etcId')?.value || null,
                startDate: item.querySelector('.etcStartDate')?.value || '',
                endDate: item.querySelector('.etcEndDate')?.value || '',
                hasEndDate: item.querySelector('.etcHasEndDate')?.checked || false,
                title: item.querySelector('.etcTitle')?.value || '',
                etcType: item.querySelector('.etcType')?.value || '',
                institutionName: item.querySelector('.etcInstitutionName')?.value || '',
                description: item.querySelector('.etcDescription')?.value || ''
            }))
        };

        console.log("업데이트 전송 데이터:", requestBody);

        try {
            let response = await fetch(`/resume/${resumeId}/update`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (response.ok) {
                alert('이력서가 성공적으로 수정되었습니다.');
                location.href = `/resume/${resumeId}`;
            } else {
                let errorBody = await response.json();
                alert('이력서 수정 실패: ' + (errorBody.msg || '알 수 없는 오류'));
            }
        } catch (error) {
            console.error('에러 발생', error);
            alert('서버 연결에 실패했습니다.');
        }
    }

    // 기술스택 표시 업데이트
    function updateTechStackButton() {
        let checkboxes = document.querySelectorAll('.techCheckbox');
        let displayBtn = document.getElementById('selectedTechStacksBtn');

        function refreshDisplay() {
            let selected = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.nextElementSibling.innerText);
            displayBtn.innerText = selected.length > 0 ? selected.join(', ') : '기술스택을 선택하세요';
        }

        checkboxes.forEach(cb => {
            cb.addEventListener('change', refreshDisplay);
        });

        refreshDisplay();
    }

    // 동적 기술스택 텍스트 반영
    function updateAllDropdownSelectedText() {
        ['.experienceItem', '.projectItem', '.trainingItem'].forEach(selector => {
            document.querySelectorAll(selector).forEach(item => {
                let container = item.querySelector('.dropdown');
                let button = container.querySelector('button.form-select');
                let selected = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.nextElementSibling.innerText);
                button.innerText = selected.length > 0 ? selected.join(', ') + ' 선택됨' : '기술스택을 선택하세요';
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateTechStackButton();
        updateAllDropdownSelectedText();

        // === [👀 toggle: section visibility 제어] ===
        const toggleMap = [
            ['togglePhoto', '#section-photo'],
            ['toggleSummary', '#section-summary'],
            ['toggleLink', '#section-link'],
            ['toggleExperience', '#section-experience'],
            ['toggleTraining', '#section-training'],
            ['toggleEtc', '#section-etc']
        ];

        toggleMap.forEach(([toggleClass, sectionId]) => {
            document.querySelectorAll(`.${toggleClass}`).forEach(toggle => {
                const section = document.querySelector(sectionId);
                if (!section) return;

                // 초기 상태 적용
                section.style.display = toggle.checked ? '' : 'none';

                // 이벤트 리스너 등록
                toggle.addEventListener('change', () => {
                    section.style.display = toggle.checked ? '' : 'none';
                });
            });
        });
    });

    // 기술스택 선택 드롭다운 실시간 갱신
    document.addEventListener('click', function (event) {
        if (
                event.target.classList.contains('experienceTechCheckbox') ||
                event.target.classList.contains('projectTechCheckbox') ||
                event.target.classList.contains('trainingTechCheckbox')
        ) {
            let container = event.target.closest('.dropdown');
            let button = container.querySelector('button.form-select');
            let selected = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.nextElementSibling.innerText);
            button.innerText = selected.length > 0 ? selected.join(', ') + ' 선택됨' : '기술스택을 선택하세요';
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        let toggleMapping = [
            { toggleId: 'toggle-photo', sectionId: 'section-photo' },
            { toggleId: 'toggle-summary', sectionId: 'section-summary' },
            { toggleId: 'toggle-link', sectionId: 'section-link' },
            { toggleId: 'toggle-experience', sectionId: 'section-experience' },
            { toggleId: 'toggle-training', sectionId: 'section-training' },
            { toggleId: 'toggle-etc', sectionId: 'section-etc' }
        ];

        toggleMapping.forEach(function (mapping) {
            let toggle = document.getElementById(mapping.toggleId);
            let section = document.getElementById(mapping.sectionId);

            if (toggle && section) {
                // 처음 로딩될 때 상태 적용
                section.style.display = toggle.checked ? 'block' : 'none';

                // 토글될 때마다
                toggle.addEventListener('change', function () {
                    if (this.checked) {
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                });
            }
        });
    });
</script>
