<script>
    // ê³µí†µ ì¶”ê°€ í•¨ìˆ˜
    function addItem(containerSelector, templateId) {
        let container = document.querySelector(containerSelector);
        let template = document.querySelector(templateId);
        let clone = template.content.cloneNode(true);
        container.appendChild(clone);
        updateAllDropdownSelectedText(); // ë“œë¡­ë‹¤ìš´ë„ ë‹¤ì‹œ ë°”ì¸ë”©
    }

    // ì‚­ì œ ë²„íŠ¼ ì²˜ë¦¬
    document.addEventListener('click', function(event) {
        if (event.target.classList.contains('removeItemBtn')) {
            event.target.closest('.linkItem, .educationItem, .experienceItem, .projectItem, .trainingItem, .etcItem').remove();
        }
    });

    // ì´ë ¥ì„œ ì—…ë°ì´íŠ¸ ì „ì†¡
    async function updateResume() {
        let resumeId = document.getElementById('resumeId').value;

        let requestBody = {
            title: document.querySelector("#title").value,
            summary: document.querySelector("#summary").value,
            selfIntroduction: document.querySelector("#selfIntroduction").value,
            isPublic: document.querySelector("#resumeToggle")?.checked ?? true,
            positionType: document.querySelector("select[name='positionType']").value,
            resumeTechStacks: Array.from(document.querySelectorAll(".techCheckbox:checked")).map(cb => cb.value),

            links: Array.from(document.querySelectorAll('.linkItem')).map(item => ({
                id: item.querySelector('.linkId')?.value || null,
                title: item.querySelector('.linkTitle')?.value || '',
                url: item.querySelector('.linkUrl')?.value || ''
            })),

            educations: Array.from(document.querySelectorAll('.educationItem')).map(item => ({
                id: item.querySelector('.educationId')?.value || null,
                graduationDate: item.querySelector('.educationGraduationDate')?.value ? item.querySelector('.educationGraduationDate').value + "-01" : null,
                isDropout: item.querySelector('.educationIsDropout')?.checked || false,
                schoolName: item.querySelector('.educationSchoolName')?.value || '',
                major: item.querySelector('.educationMajor')?.value || '',
                educationLevel: item.querySelector('.educationLevel')?.value || '',
                gpa: item.querySelector('.educationGpa')?.value || '',
                gpaScale: item.querySelector('.educationGpaScale')?.value || ''
            })),

            experiences: Array.from(document.querySelectorAll('.experienceItem')).map(item => ({
                id: item.querySelector('.experienceId')?.value || null,
                startDate: item.querySelector('.experienceStartDate')?.value || '',
                endDate: item.querySelector('.experienceEndDate')?.value || '',
                isEmployed: item.querySelector('.experienceIsEmployed')?.checked || false,
                companyName: item.querySelector('.experienceCompanyName')?.value || '',
                summary: item.querySelector('.experienceSummary')?.value || '',
                position: item.querySelector('.experiencePosition')?.value || '',
                responsibility: item.querySelector('.experienceResponsibility')?.value || '',
                techStacks: Array.from(item.querySelectorAll('.experienceTechCheckbox:checked')).map(cb => cb.value)
            })),

            projects: Array.from(document.querySelectorAll('.projectItem')).map(item => ({
                id: item.querySelector('.projectId')?.value || null,
                startDate: item.querySelector('.projectStartDate')?.value || '',
                endDate: item.querySelector('.projectEndDate')?.value || '',
                isOngoing: item.querySelector('.projectIsOngoing')?.checked || false,
                title: item.querySelector('.projectTitle')?.value || '',
                summary: item.querySelector('.projectSummary')?.value || '',
                description: item.querySelector('.projectDescription')?.value || '',
                repositoryUrl: item.querySelector('.projectRepoUrl')?.value || '',
                techStacks: Array.from(item.querySelectorAll('.projectTechCheckbox:checked')).map(cb => cb.value)
            })),

            trainings: Array.from(document.querySelectorAll('.trainingItem')).map(item => ({
                id: item.querySelector('.trainingId')?.value || null,
                startDate: item.querySelector('.trainingStartDate')?.value || '',
                endDate: item.querySelector('.trainingEndDate')?.value || '',
                isOngoing: item.querySelector('.trainingIsOngoing')?.checked || false,
                courseName: item.querySelector('.trainingCourseName')?.value || '',
                institutionName: item.querySelector('.trainingInstitutionName')?.value || '',
                description: item.querySelector('.trainingDescription')?.value || '',
                techStacks: Array.from(item.querySelectorAll('.trainingTechCheckbox:checked')).map(cb => cb.value)
            })),

            etcs: Array.from(document.querySelectorAll('.etcItem')).map(item => ({
                id: item.querySelector('.etcId')?.value || null,
                startDate: item.querySelector('.etcStartDate')?.value || '',
                endDate: item.querySelector('.etcEndDate')?.value || '',
                hasEndDate: item.querySelector('.etcHasEndDate')?.checked || false,
                title: item.querySelector('.etcTitle')?.value || '',
                etcType: item.querySelector('.etcType')?.value || '',
                institutionName: item.querySelector('.etcInstitutionName')?.value || '',
                description: item.querySelector('.etcDescription')?.value || ''
            }))
        };

        console.log("ì—…ë°ì´íŠ¸ ì „ì†¡ ë°ì´í„°:", requestBody);

        try {
            let response = await fetch(`/resume/${resumeId}/update`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (response.ok) {
                alert('ì´ë ¥ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.href = `/resume/${resumeId}`;
            } else {
                let errorBody = await response.json();
                alert('ì´ë ¥ì„œ ìˆ˜ì • ì‹¤íŒ¨: ' + (errorBody.msg || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            }
        } catch (error) {
            console.error('ì—ëŸ¬ ë°œìƒ', error);
            alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ê¸°ìˆ ìŠ¤íƒ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateTechStackButton() {
        let checkboxes = document.querySelectorAll('.techCheckbox');
        let displayBtn = document.getElementById('selectedTechStacksBtn');

        function refreshDisplay() {
            let selected = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.nextElementSibling.innerText);
            displayBtn.innerText = selected.length > 0 ? selected.join(', ') : 'ê¸°ìˆ ìŠ¤íƒì„ ì„ íƒí•˜ì„¸ìš”';
        }

        checkboxes.forEach(cb => {
            cb.addEventListener('change', refreshDisplay);
        });

        refreshDisplay();
    }

    // ë™ì  ê¸°ìˆ ìŠ¤íƒ í…ìŠ¤íŠ¸ ë°˜ì˜
    function updateAllDropdownSelectedText() {
        ['.experienceItem', '.projectItem', '.trainingItem'].forEach(selector => {
            document.querySelectorAll(selector).forEach(item => {
                let container = item.querySelector('.dropdown');
                let button = container.querySelector('button.form-select');
                let selected = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.nextElementSibling.innerText);
                button.innerText = selected.length > 0 ? selected.join(', ') + ' ì„ íƒë¨' : 'ê¸°ìˆ ìŠ¤íƒì„ ì„ íƒí•˜ì„¸ìš”';
            });
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateTechStackButton();
        updateAllDropdownSelectedText();

        // === [ğŸ‘€ toggle: section visibility ì œì–´] ===
        const toggleMap = [
            ['togglePhoto', '#section-photo'],
            ['toggleSummary', '#section-summary'],
            ['toggleLink', '#section-link'],
            ['toggleExperience', '#section-experience'],
            ['toggleTraining', '#section-training'],
            ['toggleEtc', '#section-etc']
        ];

        toggleMap.forEach(([toggleClass, sectionId]) => {
            document.querySelectorAll(`.${toggleClass}`).forEach(toggle => {
                const section = document.querySelector(sectionId);
                if (!section) return;

                // ì´ˆê¸° ìƒíƒœ ì ìš©
                section.style.display = toggle.checked ? '' : 'none';

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                toggle.addEventListener('change', () => {
                    section.style.display = toggle.checked ? '' : 'none';
                });
            });
        });
    });

    // ê¸°ìˆ ìŠ¤íƒ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì‹¤ì‹œê°„ ê°±ì‹ 
    document.addEventListener('click', function (event) {
        if (
                event.target.classList.contains('experienceTechCheckbox') ||
                event.target.classList.contains('projectTechCheckbox') ||
                event.target.classList.contains('trainingTechCheckbox')
        ) {
            let container = event.target.closest('.dropdown');
            let button = container.querySelector('button.form-select');
            let selected = Array.from(container.querySelectorAll('input:checked')).map(cb => cb.nextElementSibling.innerText);
            button.innerText = selected.length > 0 ? selected.join(', ') + ' ì„ íƒë¨' : 'ê¸°ìˆ ìŠ¤íƒì„ ì„ íƒí•˜ì„¸ìš”';
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        let toggleMapping = [
            { toggleId: 'toggle-photo', sectionId: 'section-photo' },
            { toggleId: 'toggle-summary', sectionId: 'section-summary' },
            { toggleId: 'toggle-link', sectionId: 'section-link' },
            { toggleId: 'toggle-experience', sectionId: 'section-experience' },
            { toggleId: 'toggle-training', sectionId: 'section-training' },
            { toggleId: 'toggle-etc', sectionId: 'section-etc' }
        ];

        toggleMapping.forEach(function (mapping) {
            let toggle = document.getElementById(mapping.toggleId);
            let section = document.getElementById(mapping.sectionId);

            if (toggle && section) {
                // ì²˜ìŒ ë¡œë”©ë  ë•Œ ìƒíƒœ ì ìš©
                section.style.display = toggle.checked ? 'block' : 'none';

                // í† ê¸€ë  ë•Œë§ˆë‹¤
                toggle.addEventListener('change', function () {
                    if (this.checked) {
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                });
            }
        });
    });
</script>
